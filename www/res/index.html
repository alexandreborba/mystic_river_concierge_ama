<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1080, height=1920, initial-scale=1.0">
  <title>Menu Vertical - Slideshow</title>
  <style>
    :root{
      /* Fallbacks – serão substituídos via JS com APP_CONFIG */
      --progress-height: 8px;
      --progress-color: rgba(255,255,255,1);
      --progress-bg: rgba(0,0,0,0.25);
    }

    body { margin: 0; background-color: #fff; height: 100vh; overflow: hidden; }
    #slideshow { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
    .slide.active { display: block; }

    /* Barra de progresso no rodapé (apenas 2+ slides) */
    #progress{
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: var(--progress-height);
      background: var(--progress-bg);
      z-index: 10;
      display: none;      /* controlado via JS */
      overflow: hidden;
      pointer-events: none;
    }
    #progress-bar{
      width: 0%;
      height: 100%;
      background: var(--progress-color);
      transition: none;   /* quem anima é o jQuery */
    }
    /* Visual opcional quando pausado (transição a decorrer) */
    #progress.paused #progress-bar {
      opacity: 0.6;
    }
  </style>

  <!-- Carrega js/_config.js com timestamp para evitar cache -->
  <script>
    (function () {
      const v = Date.now();
      const s = document.createElement('script');
      s.src = 'js/_config.js?v=' + v;
      s.async = false;
      document.head.appendChild(s);
    })();
  </script>
</head>
<body>
  <div id="slideshow">
    <!-- Barra de progresso -->
    <div id="progress" aria-hidden="true">
      <div id="progress-bar"></div>
    </div>
  </div>

  <script src="jquery/jquery-3.7.1.min.js"></script>

  <script>
  (function boot() {
    function whenDomReady(fn) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn, { once: true });
      } else {
        fn();
      }
    }

    function cssSize(val, fallback) {
      if (typeof val === 'number') return val + 'px';
      if (typeof val === 'string' && val.trim()) return val.trim();
      return fallback;
    }

    function startApp() {
      const APP = window.APP_CONFIG || {};

      // Aplica APP_CONFIG às CSS variables (sobrepõe os fallbacks do <style>)
      const rootStyle = document.documentElement.style;
      rootStyle.setProperty('--progress-color',  APP.progressbar_color  || 'rgba(255,255,255,1)');
      rootStyle.setProperty('--progress-height', cssSize(APP.progressbar_height, '8px'));
      rootStyle.setProperty('--progress-bg',     APP.progressbar_bg     || 'rgba(0,0,0,0.25)');

      // Config da aplicação
      const { shipCode, server, container, tokenAPI } = APP;
      const apiHost      = /^https?:\/\//i.test(server) ? server : 'http://' + server;
      const pathAPI      = `${apiHost}/${container}/apis/dailyMenusVerticais/getFiles/${shipCode}`;
      const basePath     = `${apiHost}/${container}/media/dMenusv/`;
      const fallbackBase = `${apiHost}/${container}/nocontent/restaurant/`;

      // Parâmetros do slideshow
      const SLIDE_DURATION      = 10000;   // ms em exibição
      const TRANSITION_DURATION = 900;     // ms transição entre slides
      const ANIMATION_TYPE      = 'fade';  // 'fade' | 'slide-left' | 'slide-right'
      const POLL_INTERVAL       = 5000;    // ms polling API

      let rotationTimer = null;
      let lastFilesJson = null;

      // --- PROGRESS BAR helpers (com pausa durante transição) ---
      const $progress    = $('#progress');
      const $progressBar = $('#progress-bar');

      function hideProgress(){
        $progress.removeClass('paused').hide();
        $progressBar.stop(true, true).css('width', '0%');
      }
      function startProgress(duration){
        $progress.removeClass('paused').show();
        $progressBar.stop(true, true).css('width', '0%')
                   .animate({ width: '100%' }, { duration, easing: 'linear' });
      }
      function pauseProgress(){
        // congela a largura atual e marca estado pausado
        $progress.addClass('paused');
        $progressBar.stop(true, false); // true: clear queue, false: NÃO salta para fim
      }
      // ---------------------------------------------------------

      /**
       * Inicia/reinicia o slideshow.
       * - 0 slides: nada
       * - 1 slide: exibe estático + oculta barra
       * - 2+ slides: roda, barra anima durante exibição, PAUSA durante transição
       */
      function initSlideshow(files, path) {
        clearInterval(rotationTimer);
        $('#slideshow').children('.slide').remove();
        hideProgress();

        // Insere imagens
        files.forEach(file => {
          $('<img>')
            .attr('src', path + file)
            .addClass('slide')
            .css('transition', `${TRANSITION_DURATION}ms ease`)
            .appendTo('#slideshow');
        });

        const $slides = $('#slideshow').find('.slide');
        const n = $slides.length;
        if (n === 0) return;

        if (n === 1) {
          $slides.eq(0).addClass('active').show();
          hideProgress();
          return;
        }

        // >=2 imagens: slideshow + barra
        let current = 0;
        $slides.eq(0).addClass('active').fadeIn(TRANSITION_DURATION, () => {
          startProgress(SLIDE_DURATION); // anima durante o tempo de exibição
        });

        rotationTimer = setInterval(() => {
          // Começa a transição: PAUSA a barra no estado atual
          pauseProgress();

          const $out = $slides.eq(current);
          const next = (current + 1) % n;
          const $in  = $slides.eq(next);

          if (ANIMATION_TYPE === 'fade') {
            $out.fadeOut(TRANSITION_DURATION);
            $in.fadeIn(TRANSITION_DURATION, () => {
              $out.removeClass('active');
              $in.addClass('active');
              // Nova exibição: reinicia a barra do zero
              startProgress(SLIDE_DURATION);
            });
          } else if (ANIMATION_TYPE === 'slide-left') {
            $in.css({ left: '100%', display: 'block' })
               .animate({ left: '0%' }, TRANSITION_DURATION);
            $out.animate({ left: '-100%' }, TRANSITION_DURATION, () => {
              $out.css({ display: 'none', left: 0 }).removeClass('active');
              $in.addClass('active');
              startProgress(SLIDE_DURATION);
            });
          } else if (ANIMATION_TYPE === 'slide-right') {
            $in.css({ left: '-100%', display: 'block' })
               .animate({ left: '0%' }, TRANSITION_DURATION);
            $out.animate({ left: '100%' }, TRANSITION_DURATION, () => {
              $out.css({ display: 'none', left: 0 }).removeClass('active');
              $in.addClass('active');
              startProgress(SLIDE_DURATION);
            });
          }
          current = next;
        }, SLIDE_DURATION + TRANSITION_DURATION);
      }

      // Polling e atualização condicional
      function pollMenus() {
        $.ajax({
          url: pathAPI,
          type: 'GET',
          dataType: 'json',
          headers: { 'Authorization': 'Bearer ' + tokenAPI },
          success(data) {
            const items = Array.isArray(data) ? data : [data];
            items.sort((a, b) => a.dmvOrder - b.dmvOrder);

            let files = [], path = basePath;
            if (items.length > 0) {
              if (items[0].dmvFile === 'no_content.png') {
                files = ['no_content.png' + '?' + items[0].dmvDate];
                path = fallbackBase;
              } else {
                files = items.map(item => item.dmvFile + '?' + item.dmvDate);
                path = basePath;
              }
            }

            const filesJson = JSON.stringify(files);
            if (filesJson !== lastFilesJson) {
              lastFilesJson = filesJson;
              initSlideshow(files, path);
            }
          },
          complete() {
            setTimeout(pollMenus, POLL_INTERVAL);
          }
        });
      }

      pollMenus();
    }

    function tryStart() {
      if (window.APP_CONFIG && window.jQuery) {
        whenDomReady(startApp);
      } else {
        setTimeout(tryStart, 50);
      }
    }

    tryStart();
  })();
  </script>
</body>
</html>